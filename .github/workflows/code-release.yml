name: Release on PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  create_release:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Zip the repository
        run: |
          cd containers/lambda/
          if ! command -v zip &> /dev/null
          then
              echo "zip command could not be found. Please install zip package."
              exit 1
          fi

          for dir in */
          do
              base=$(basename "$dir")
              version_file="${dir}version.py"

              echo "Processing directory: $base"
              echo "Version file: $version_file"

              if [ -f "$version_file" ]; then
                  version=$(grep -oP '__version__ = "\K[^\"]+' "$version_file")
                  echo "Version found: $version"
                  if [ -n "$version" ]; then
                      zip_name="${base%/}-${version}.zip"
                  else
                      zip_name="${base%/}.zip"
                  fi
              else
                  zip_name="${base%/}.zip"
              fi

              echo "Creating zip file: $zip_name"
              zip -r "$zip_name" "$dir"
          done

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh

      - name: GitHub CLI configuration
        run: echo "GH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_ENV

      - name: Create release and upload zip using Python
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 - <<'EOF'
          import os
          import subprocess

          # Fetch PR details from the GitHub event
          tag_name = f"r{os.getenv('GITHUB_EVENT_NUMBER')}"
          pr_title = os.getenv('GITHUB_EVENT_PULL_REQUEST_TITLE')
          pr_description = os.getenv('GITHUB_EVENT_PULL_REQUEST_BODY')

          # Convert single newlines to newline with two spaces for Markdown formatting
          escaped_pr_description = pr_description.replace('\n', '  \n')
          escaped_pr_description = escaped_pr_description.replace('### ', '\n### ').replace('- ', '\n- ')

          release_notes = f"**Title:** {pr_title}\n**Description:** {escaped_pr_description}"

          # Create GitHub release using gh CLI
          try:
              result = subprocess.run(
                  ['gh', 'release', 'create', tag_name, 'containers/lambda/*.zip', '--title', tag_name, '--notes', release_notes],
                  check=True,
                  stdout=subprocess.PIPE,
                  stderr=subprocess.PIPE,
                  text=True
              )
              print(f"Release created successfully:\n{result.stdout}")
          except subprocess.CalledProcessError as e:
              print(f"Error while creating release:\n{e.stderr}")
          EOF
